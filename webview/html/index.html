<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Security-Policy">
	<title>Test</title>
	<style>
		DIALOG_CSS

		/* The Modal (background) */
		.modal {
			display: none;
			/* Hidden by default */
			position: fixed;
			/* Stay in place */
			z-index: 1;
			/* Sit on top */
			left: 0;
			top: 0;
			width: 100%;
			/* Full width */
			height: 100%;
			/* Full height */
			overflow: auto;
			/* Enable scroll if needed */
			background-color: rgb(0, 0, 0);
			/* Fallback color */
			background-color: rgba(0, 0, 0, 0.4);
			/* Black w/ opacity */
			padding-top: 60px;
		}

		/* Modal Content/Box */
		.modal-content {
			background-color: #fefefe;
			padding: 40px;
			margin: 5% auto 15% auto;
			/* 5% from the top, 15% from the bottom and centered */
			border: 1px solid #888;
			width: 60%;
			/* Could be more or less, depending on screen size */
		}


		/* Add Zoom Animation */
		.animate {
			-webkit-animation: animatezoom 0.6s;
			animation: animatezoom 0.6s
		}

		@-webkit-keyframes animatezoom {
			from {
				-webkit-transform: scale(0)
			}

			to {
				-webkit-transform: scale(1)
			}
		}

		@keyframes animatezoom {
			from {
				transform: scale(0)
			}

			to {
				transform: scale(1)
			}
		}

		/* Full-width input fields */
		input[type=text],
		input[type=password],
		input[type=number],
		select {
			width: 100%;
			padding: 12px 20px;
			margin: 8px 0;
			display: inline-block;
			border: 1px solid #ccc;
			box-sizing: border-box;
		}

		input[type=button] {
			background-color: rgb(14, 99, 156);
			border: none;
			color: white;
			padding: 15px 32px;
			text-align: center;
			text-decoration: none;
			display: inline-block;
			font-size: 16px;
		}

		.notsaved {
			background-color: lightgrey !important;
		}

		.saveAllButton {
			position: fixed;
			top: 100%;
			left: 100%;
			transform: translate(-130%, -150%);
		}

		.additionalInfoDiv {
			border: 1px solid #d73a49;
			padding: 25px;
			margin: 0px 40px 40px 40px;
			border-radius: 6px;
		}

		.basicInfoForElement {
			border: 1px solid #2ea44f;
			padding: 25px;
			margin: 0px 0px 10px 0px;
			border-radius: 6px;
		}

		.tooltip {
			position: relative;
			display: inline-block;
			border-bottom: 1px dotted black;
		}

		.tooltip .tooltiptext {
			visibility: hidden;
			width: 120px;
			background-color: #555;
			color: #fff;
			text-align: center;
			border-radius: 6px;
			padding: 5px 0;
			position: absolute;
			z-index: 1;
			bottom: 125%;
			left: 50%;
			margin-left: -60px;
			opacity: 0;
			transition: opacity 0.3s;
		}

		.tooltip .tooltiptext::after {
			content: "";
			position: absolute;
			top: 100%;
			left: 50%;
			margin-left: -5px;
			border-width: 5px;
			border-style: solid;
			border-color: #555 transparent transparent transparent;
		}

		.tooltip:hover .tooltiptext {
			visibility: visible;
			opacity: 1;
		}

		.text_of_element {
			width: fit-content;
		}
	</style>
</head>

<body style="color: black; background-color: #bfdbff;">
	<script src="JQUERY_PATH"></script>

	<div id="AusblendenWarnung" class="modal">
		<div class="modal-content animate">
			<div class="additionalInfoDiv">
				ACHTUNG!!!<br>
				Das löschen eines Elements blendet es nicht aus. Um ein Element aus dem Dialog auszublenden, muss man das Element auf VISIBLE=0 setzen<br><br>
				Warnung nicht nochmal anzeigen: <input type="checkbox" name="showWarningAgain" id="showWarningAgain">
				<button onclick="document.getElementById('AusblendenWarnung').style.display = 'none';">OK</button>
			</div>
		</div>
	</div>


	<div id="id01" class="modal">

		<div class="modal-content animate">
			Type:<select onchange="OnChangeSelectType(event)" name="type" id="type">
				<option value="1">STATIC </option>
				<option value="2">GROUPBOX </option>
				<option value="3">PICTURE </option>
				<option value="4">LINE </option>
				<option value="5">RECTANGLE </option>
				<option value="6">STATICLED </option>
				<option value="10">BUTTON </option>
				<option value="11">BUTTONOK </option>
				<option value="12">BUTTONCANCEL </option>
				<option value="13">BITMAPBUTTON </option>
				<option value="15">CHECKBOX </option>
				<option value="16">RADIO </option>
				<option value="20">EDIT </option>
				<option value="21">EDIT_MULTILINE </option>
				<option value="22">EDIT_NUMERIC </option>
				<option value="23">EDIT_PASSWORD </option>
				<option value="24">EDIT_MONEY </option>
				<option value="25">EDIT_DATE </option>
				<option value="26">EDIT_TIME </option>
				<option value="27">EDIT_IPADDRESS </option>
				<option value="28">EDIT_DATETIME </option>
				<option value="29">EDIT_PERCENT </option>
				<option value="30">EDIT_RICH </option>
				<option value="31">EDIT_COLOR </option>
				<option value="35">GRAPHICPAINTER </option>
				<option value="40">COMBO </option>
				<option value="41">LIST </option>
				<option value="42">LISTVIEW </option>
				<option value="43">LISTVIEWSUBTABLE </option>
				<option value="44">LISTVIEWLINKTABLE </option>
				<option value="45">LISTVIEWLINKEDTABLE </option>
				<option value="46">LISTVIEWLINKTABLEDOCUMENT </option>
				<option value="47">LISTVIEWLINKTABLEPICTURES </option>
				<option value="48">TREELIST </option>
				<option value="49">TREEVIEW </option>
				<option value="50">SPIN </option>
				<option value="51">SLIDER </option>
				<option value="52">PROGRESS </option>
				<option value="60">TAB </option>
				<option value="70">LINK_COMBO </option>
				<option value="72">LINK_SEARCH </option>
				<option value="80">COMBO_TREE </option>
				<option value="81">LINK_COMBO_TREE </option>
				<option value="82">LINK_CHECKCOMBO </option>
				<option value="100">EXTERNWINDOW </option>
				<option value="200">PAGE </option>
				<option value="201">RB_TAB </option>
				<option value="202">RB_GROUP </option>
				<option value="203">RB_BUTTON </option>
				<option value="204">RB_POPUP </option>
				<option value="205">RB_BUTTONPOPUP </option>
				<option value="206">RB_SPLITBUTTONPOPUP </option>
				<option value="207">RB_COMBOBOX </option>
				<option value="208">RB_EDIT </option>
				<option value="209">RB_CUSTOM </option>
				<option value="210">RB_LABEL </option>
				<option value="211">RB_CHECKBOX </option>
				<option value="212">RB_GALLERY </option>
				<option value="213">RB_FASTBUTTON </option>
				<option value="214">RB_FASTEDIT </option>
				<option value="215">RB_MENUITEM </option>
				<option value="216">RB_RADIOGROUP </option>
				<option value="217">RB_LISTVIEW </option>
				<option value="218">RB_EDIT_DATE </option>
				<option value="219">RB_LINK_COMBO </option>
				<option value="220">RB_LINK_SEARCH </option>
				<option value="221">RB_STATIC </option>
				<option value="222">RB_SYSMENU </option>
				<option value="223">TITLESTRING </option>
				<option value="224">RB_EDIT_MULTILINE </option>
				<option value="225">NOTE </option>
				<option value="226">MONTHCALENDAR </option>
				<option value="227">LINK_COMBO_DOCUMENT </option>
				<option value="228">RB_LINK_COMBO_TREE </option>
	
	
			</select>
			<div id="linkedtable_info" style="display: none;" class="additionalInfoDiv">
				<p style="margin: 0px 0px 20px 0px;">Zusatzinfos zur LinkedTable:</p>
				<table>
					<thead>
						<td></td>
						<td></td>
						<td></td>
					</thead>
					<tbody>
						<td>Tabellenlink: <input type="text" name="tabellenlink_linkedtable" id="tabellenlink_linkedtable"></td>
						<td>Spaltenanzeige: <input type="text" name="spaltenlink_linkedtable" id="spaltenlink_linkedtable"></td>
						<td>Spaltenbreite: <input type="text" name="spaltenbreite_linkedtable" id="spaltenbreite_linkedtable"></td>
					</tbody>
				</table>
				
			</div>

			<div class="basicInfoForElement">
				<p style="margin: 0px 0px 20px 0px;">Allgemeine Infos zum Element:</p>
				<table style="width: 100%;" >
					<thead>
						<td style="width: 33.33%;"></td>
						<td style="width: 33.33%;"></td>
						<td style="width: 33.33%;"></td>
					</thead>
					<tbody>
						<tr>
							<td>Page:<input id="page" type="number"></td>
							<td><div class="tooltip">
								<span class="tooltiptext">An welcher Seite des eigentlichen Elements sollte der Name angezeigt werden</span>
								Nameposition:</div><select name="nameposition" id="nameposition">
								<option value="1">Oben</option>
								<option value="2">Rechts</option>
								<option value="3">Unten</option>
								<option value="4">Links</option>
							</select></td>
							<td>Next Tab:<input id="nexttab" type="number"></td>
						</tr>
						<tr>
							<td>Visible:<select name="visible" id="visible">
								<option value="1">Ja</option>
								<option value="0">Nein</option>
							</select></td>
							<td>Readonly:<select name="readonly" id="readonly">
								<option value="1">Ja</option>
								<option value="0">Nein</option>
							</select></td>
							<td>Breite:<input type="number" name="elementwidth" id="elementwidth"></td>
						</tr>
						<tr>
							<td>Höhe:<input step="0.1" type="number" name="elementheight" id="elementheight"><button id="standardwidth" onclick="document.getElementById('elementheight').value='1.2'">Standard</button></td>
						</tr>
					</tbody>
				</table>
				
				
				Name:<input id="name" type="text">
				OnChange:<input id="onchange" type="text">
				<input id="column" type="hidden">
				<p id="column_info"></p>
			</div>
			<input type="button" value="Speichern" onclick="Postmessage(false)">
			<input type="button" value="Abbrechen"
				onclick="document.getElementById('id01').style.display='none'; document.getElementById('linkedtable_info').style.display='none';">
		</div>
	</div>

	<div id="main_dialog" style="border-top-color: black;
    border-top-style: solid;
    border-top-width: 1px;
    border-left-color: black;
    border-left-style: solid;
    border-left-width: 1px; margin: 20px; width: 100%; height: 100%; position: absolute;">
		DIALOG_HTML
	</div>

	<input type="button" id="saveAllButton" style="display: none;" class="saveAllButton" value="Alle Elemente speichern"
		onclick="Postmessage(true)">

	<script>
		const xFactor = 5;
		const yFactor = 40;
		const heightFactor = 20;
		
		const vscode = acquireVsCodeApi();
		let table = TABLE_NUMBER;

		function Postmessage(saveAll) {
			document.getElementById('id01').style.display = 'none';
			$('linkedtable_info').fadeOut(1);

			let arr = [];
			let elements = [];

			if (!saveAll) {
				let element = document.getElementById("" + table + "-" + document.getElementById("column").value);
				elements.push(element);
				
			} else {
				elements = document.querySelectorAll(".notsaved");
			}

			let allElementsChange = [];
			elements.forEach((element) => {
				let column = "";
				let onchange = "";
				let nexttab = "";
				let page = "";
				let type = "";
				let nameposition = "";
				let visible = "";
				let readonly = "";
				let name = "";
				let elementwidth = "";
				let elementheight = "";
				if (saveAll) {
					column = element.getAttribute("data-column");
					onchange = element.getAttribute("data-onchange");
					nexttab = element.getAttribute("data-nexttab");
					page = element.getAttribute("data-page");
					type = element.getAttribute("data-type");
					nameposition = element.getAttribute("data-nameposition");
					visible = element.getAttribute("data-visible");
					readonly = element.getAttribute("data-readonly");
					name = element.getAttribute("data-name");
					elementheight = element.getAttribute("data-height");
					elementwidth = element.getAttribute("data-width");
				} else {
					column = document.getElementById("column").value;
					onchange = document.getElementById("onchange").value;
					nexttab = document.getElementById("nexttab").value;
					page = document.getElementById("page").value;
					type = document.getElementById("type").value;
					nameposition = document.getElementById("nameposition").value;
					visible = document.getElementById("visible").value;
					readonly = document.getElementById("readonly").value;
					name = document.getElementById("name").value;
					elementheight = document.getElementById("elementheight").value;
					elementwidth = document.getElementById("elementwidth").value;

					element.setAttribute("data-column", column);
					element.setAttribute("data-onchange", onchange);
					element.setAttribute("data-nexttab", nexttab);
					element.setAttribute("data-page", page);
					element.setAttribute("data-type", type);
					element.setAttribute("data-nameposition", nameposition);
					element.setAttribute("data-visible", visible);
					element.setAttribute("data-readonly", readonly);
					element.setAttribute("data-name", name);
					element.setAttribute("data-height", elementheight);
					element.setAttribute("data-width", elementwidth);
					if (type != 15) {
						element.children[0].innerHTML = name;
						if(element.children[0].innerHTML && element.children[0].innerHTML.length > 0) {


							if(nameposition == 1) {
								element.children[0].style.left = "0px";
								element.children[0].style.position = "relative";
								element.children[0].style.top = "-20px";
							} else {
								element.children[0].style.top = "0px";
								element.children[0].style.left = "-" + (element.children[0].width + 5) + "px";
								element.children[0].style.position = "relative";
							}

						}

						if(readonly == 0) {
							element.style.backgroundColor = "white";
						} else {
							element.style.backgroundColor = "black";
						}

					} else {
						let style = `style="background-color: <BACKGROUNDCOLOR>;"`;
						if(readonly == 0) {
							style.replace("<BACKGROUNDCOLOR>", "white");
						} else {
							style.replace("<BACKGROUNDCOLOR>", "black");
						}

						element.innerHTML = `<input ${style} type="checkbox">` + name;
					}

					if(visible == 0) {
						element.style.display = "none";
					} else {
						element.style.opacity = "1";
					}
					
					let width = "" + (parseFloat(elementwidth) * xFactor).toFixed(1) + "px";
					element.style.width = width;
					element.style.height = "" + (parseFloat(elementheight) * heightFactor).toFixed(1) + "px";
				}

				element.className = element.className.replace(" notsaved", "");

				arr = [];
				if (!saveAll) {

					arr.push({
						type: "TYPE=",
						text: type
					});
					arr.push({
						type: "PAGE=",
						text: page
					});
				}

				arr.push({
					type: "XPOS=",
					text: element.style.left
				})
				arr.push({
					type: "YPOS=",
					text: element.style.top
				})
				arr.push({
					type: "WIDTH=",
					text: element.style.width
				})
				arr.push({
					type: "HEIGHT=",
					text: element.style.height
				})

				if (!saveAll) {
					arr.push({
						type: "NEXTTABPOS=",
						text: nexttab
					});
					arr.push({
						type: "NAMEPOSITION=",
						text: nameposition
					});
					arr.push({
						type: "VISIBLE=",
						text: visible
					});
					arr.push({
						type: "READONLY=",
						text: readonly
					});
					arr.push({
						type: "NAME=",
						text: name
					});
					arr.push({
						type: "ONCHANGE=",
						text: onchange
					});
				}

				allElementsChange.push({
					column: column,
					command: 'saveChanges',
					table: table,
					values: arr,
					type: type,
					name: name
				});
			});

			if (document.querySelectorAll(".notsaved").length <= 0) {
				document.getElementById("saveAllButton").style.display = "none";
			}

			vscode.postMessage(allElementsChange);
		}

		// Get the modal
		var modal = document.getElementById('id01');

		// When the user clicks anywhere outside of the modal, close it
		window.onclick = function (event) {
			if (event.target == modal) {
				modal.style.display = "none";
				$('linkedtable_info').fadeOut(1);
			}
		}

		function showElementDialog(event) {
			if (event.ctrlKey && !event.altKey && !event.shiftKey) {
				let target = event.target;
				if (target.className.search("text_of_element") >= 0) {
					target = event.target.parentElement;
				}
				document.getElementById("column").value = target.getAttribute("data-column");
				document.getElementById("column_info").innerHTML = "Spalte: " + target.getAttribute("data-column");
				document.getElementById("onchange").value = target.getAttribute("data-onchange");
				document.getElementById("nexttab").value = target.getAttribute("data-nexttab");
				document.getElementById("page").value = target.getAttribute("data-page");
				document.getElementById("type").value = target.getAttribute("data-type");
				document.getElementById("nameposition").value = target.getAttribute("data-nameposition");
				document.getElementById("visible").value = target.getAttribute("data-visible");
				document.getElementById("readonly").value = target.getAttribute("data-readonly");
				document.getElementById("name").value = target.getAttribute("data-name");
				document.getElementById("elementheight").value = target.getAttribute("data-height");
				document.getElementById("elementwidth").value = target.getAttribute("data-width");

				document.getElementById('id01').style.display = 'block';

				if (target.getAttribute("data-type") == 45) {
					document.getElementById("linkedtable_info").style.display = "block";
				} else {
					document.getElementById("linkedtable_info").style.display = "none";
				}

			} else if (event.ctrlKey && event.altKey && event.shiftKey) {

				if(document.getElementById('showWarningAgain').checked == false) {
					document.getElementById('AusblendenWarnung').style.display = "block";
				}

				vscode.postMessage([{
					command: "removeElement",
					table: table,
					type: "" + event.target.getAttribute("data-type"),
					name: "" + event.target.getAttribute("data-name"),
					column: "" + event.target.getAttribute("data-column")
				}])
				document.getElementById(activeIndex).removeChild(event.target);
			}
		}

		function OnChangeSelectType(event) {
			if (event.target.value == 45) {
				$("#linkedtable_info").fadeIn(600);
			}
			else {
				$("#linkedtable_info").fadeOut(600);
			}
		}
	</script>

	<script type="module">
		import { dragmove } from 'ONDISKPATH';

		// Use the start/end events to simulate "snap to edge" behaviour.
		const snapThreshold = 50;
		function onStart(el, x, y) {
			// On drag start, remove the fixed bottom style to prevent the bottom
			// from sticking on the screen.
			el.style.top = el.offsetTop + "px";
			el.style.bottom = "auto";
		}

		function onEnd(el, x, y) {

			if (el.className.search("notsaved") < 0) {
				el.className += " notsaved";
			}

			document.getElementById("saveAllButton").style.display = "block";
			// Automatically snap to corners.
			if (el.style.top / 40 <= 0) {
				el.style.top = "0px"
			}
			// if (window.innerWidth - (el.offsetLeft + el.offsetWidth) < snapThreshold) {
			// 	el.style.left = "auto"
			// 	el.style.right = "0px"
			// }
			// if (el.offsetTop < snapThreshold) {
			// 	el.style.top = "0px"
			// }
			// if (el.offsetLeft < snapThreshold) {
			// 	el.style.left = "0px"
			// }
		}

		(function () {
			let v = document.querySelectorAll(".Testungen");
			v.forEach((value) => {
				if(value.getAttribute("data-type") != 4 && value.getAttribute("data-type") != 15) {
					if(value.children && value.children[0] && value.children[0].innerHTML && value.children[0].innerHTML.length > 0) {
						value.children[0].style.left = "-" + (value.children[0].offsetWidth + 5) + "px";
						value.children[0].style.position = "relative";
					}
				}

				if(value.getAttribute("data-nameposition") == 1) {
					value.children[0].style.left = "0px";
					value.children[0].style.position = "relative";
					value.children[0].style.top = "-20px";
				}
				
				dragmove(value, value, onStart, onEnd);
			});

			let newelementsID = 100000;
			window.addEventListener("click", (event) => {
				if (event.ctrlKey && event.altKey && !event.shiftKey) {
					event.stopPropagation();

					let newElement = document.createElement("div");
					newElement.style.backgroundColor = "white";
					newElement.style.resize = "none";
					newElement.style.height = "20px";
					newElement.style.top = "" + event.offsetY + "px";
					newElement.style.left = "" + event.offsetX + "px";
					newElement.style.width = `${(35 * xFactor)}px`;
					newElement.style.position = "absolute";
					newElement.style.border = " 1px solid #7a7a7a";

					newElement.onclick = showElementDialog;
					newElement.setAttribute("data-saved", "1");
					newElement.setAttribute("data-column", "");
					newElement.setAttribute("data-onchange", "");
					newElement.setAttribute("data-nexttab", "0");
					newElement.setAttribute("data-page", activeIndex);
					newElement.setAttribute("data-type", "25");
					newElement.setAttribute("data-nameposition", "4");
					newElement.setAttribute("data-visible", "1");
					newElement.setAttribute("data-readonly", "0");
					newElement.setAttribute("data-name", "new_element");
					newElement.className += " Testungen notsaved";
					newElement.innerHTML = "<div class='text_of_element'>Neues Element</div>";
					newElement.id = "" + table + "-" + newelementsID;

					document.getElementById(activeIndex).appendChild(newElement);
					dragmove(newElement, newElement, onStart, onEnd);

					vscode.postMessage([{
						command: "askColumn",
						id: newelementsID
					}])
					newelementsID++;
				}
			});

			// Handle the message inside the webview
			window.addEventListener('message', event => {
				const message = event.data; // The JSON data our extension sent
				switch (message.command) {
					case 'setColumnOfNewElement':
						let element = document.getElementById("" + table + "-" + message.id);
						element.setAttribute("data-column", "" + message.newid);
						element.id = "" + table + "-" + message.newid;

						break;
				}
			});

		})();
	</script>
</body>

</html>